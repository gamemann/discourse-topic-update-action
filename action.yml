name: Update Discourse Topic
description: "Automatically updates contents of a Discourse topic with the contents of a file in the repository."

inputs:
  file:
    description: "The file with Markdown to replace the Discourse topic with."
    required: true

runs:
  using: "composite"

  env:
    DISCOURSE_API_KEY: ${{ secrets.DISCOURSE_API_KEY }}
    DISCOURSE_API_USER: ${{ secrets.DISCOURSE_API_USER }}
    DISCOURSE_TOPIC_ID: ${{ secrets.DISCOURSE_TOPIC_ID }}
    DISCOURSE_API_URL: ${{ secrets.DISCOURSE_API_URL }}

  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y jq gawk

    - name: Read and transform repository file.
      id: read-and-fix
      run: |
        ./scripts/fix_links.sh .dtua/links.env ${{ inputs.file }} > tmp.md
        echo "README_JSON=$(jq -Rs . tmp.md)" >> $GITHUB_ENV

    - name: Get first post ID from topic (and verify it's the first)
      id: get_post

      run: |
        response=$(curl -s "${DISCOURSE_API_URL}/t/${DISCOURSE_TOPIC_ID}/posts.json" \
          -H "Api-Key: ${DISCOURSE_API_KEY}" \
          -H "Api-Username: ${DISCOURSE_API_USER}")

        post=$(echo "$response" | jq '.post_stream.posts[0]')
        post_id=$(echo "$post" | jq '.id')
        post_number=$(echo "$post" | jq '.post_number')

        echo "First Post ID: $post_id"
        echo "Post Number: $post_number"

        if [ "$post_number" != "1" ]; then
          echo "❌ Error: This is not the first post in the topic. Aborting."
          exit 1
        fi

        echo "POST_ID=$post_id" >> $GITHUB_ENV

    - name: Update Discourse post
      env:
        DISCOURSE_API_KEY: ${{ secrets.DISCOURSE_API_KEY }}
        DISCOURSE_API_USER: ${{ secrets.DISCOURSE_API_USER }}
        DISCOURSE_API_URL: ${{ secrets.DISCOURSE_API_URL }}
        POST_ID: ${{ env.POST_ID }}
        README_JSON: ${{ env.README_JSON }}
      run: |
        echo "✅ Updating post ID: $POST_ID"

        curl -X PUT "${DISCOURSE_API_URL}/posts/${POST_ID}.json" \
          -H "Content-Type: application/json" \
          -H "Api-Key: ${DISCOURSE_API_KEY}" \
          -H "Api-Username: ${DISCOURSE_API_USER}" \
          -d "{\"post\": {\"raw\": $README_JSON}}"

        echo "✅ Update complete."